/**
 * ============================================================
 * ØªØµÙÙŠØ© Ø¨Ø±Ùˆ - Tasfiya Pro
 * Build Script - Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ù†Ø§Ø¡ Ù†Ø¸ÙŠÙ ÙˆØ¨Ø³ÙŠØ·
 * ============================================================
 * Ø¥ØµØ¯Ø§Ø±: 4.0.1
 * Ø§Ù„ØªØ§Ø±ÙŠØ®: 2026-02-02
 * ============================================================
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function runCommand(cmd, description) {
  try {
    log(`\nâ–¶ï¸  ${description}...`, 'cyan');
    execSync(cmd, { stdio: 'inherit' });
    log(`âœ… ${description} - Ù†Ø¬Ø­`, 'green');
    return true;
  } catch (error) {
    log(`âŒ ${description} - ÙØ´Ù„`, 'red');
    return false;
  }
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
// ============================================================
function checkRequiredFiles() {
  log('\nğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©...', 'blue');

  const requiredFiles = [
    'src/main.js',
    'src/index.html',
    'src/app.js',
    'src/styles.css',
    'src/database.js',
    'package.json'
  ];

  const missingFiles = requiredFiles.filter(file => !fs.existsSync(file));

  if (missingFiles.length > 0) {
    log('âŒ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©:', 'red');
    missingFiles.forEach(file => log(`   - ${file}`, 'red'));
    process.exit(1);
  }

  log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©', 'green');
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
// ============================================================
function cleanOldBuilds() {
  log('\nğŸ—‘ï¸  ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...', 'blue');

  const dirsToClean = ['dist', 'dist-final-v4.0.0', 'dist-v4.0.0', 'out'];

  dirsToClean.forEach(dir => {
    if (fs.existsSync(dir)) {
      try {
        fs.rmSync(dir, { recursive: true, force: true });
        log(`   âœ“ ØªÙ… Ø­Ø°Ù ${dir}`, 'cyan');
      } catch (error) {
        log(`   âš ï¸  Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù ${dir}`, 'yellow');
      }
    }
  });

  log('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©', 'green');
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
// ============================================================
function installDependencies() {
  runCommand('npm install', 'ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª (npm install)');
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© (Native Modules)
// ============================================================
function rebuildNativeModules() {
  runCommand(
    'npx @electron/rebuild -f',
    'Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Electron'
  );
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================================
function buildApplication() {
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† package.json Ù…Ø¨Ø§Ø´Ø±Ø©
  runCommand(
    'npx electron-builder --win --x64',
    'Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Electron Builder)'
  );
}

// ============================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
// ============================================================
function verifyBuild() {
  log('\nğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ù†Ø§Ø¡...', 'blue');

  if (!fs.existsSync('dist')) {
    log('âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡: Ù…Ø¬Ù„Ø¯ dist ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'red');
    process.exit(1);
  }

  const distFiles = fs.readdirSync('dist').filter(f =>
    f.endsWith('.exe') || f.endsWith('.nsis')
  );

  if (distFiles.length === 0) {
    log('âš ï¸  ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª .exe ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ dist', 'yellow');
  } else {
    log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:', 'green');
    distFiles.forEach(file => log(`   - ${file}`, 'cyan'));
  }
}

// ============================================================
// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// ============================================================
async function main() {
  try {
    log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'blue');
    log('â•‘     ØªØµÙÙŠØ© Ø¨Ø±Ùˆ - Tasfiya Pro - Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡            â•‘', 'blue');
    log('â•‘          Clean Build Script v4.0.0                     â•‘', 'blue');
    log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'blue');

    // Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª
    checkRequiredFiles();

    // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    cleanOldBuilds();

    // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
    installDependencies();

    // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    rebuildNativeModules();

    // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    buildApplication();

    // Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    verifyBuild();

    // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'green');
    log('â•‘          ğŸ‰ ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰              â•‘', 'green');
    log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'green');
    log('\nğŸ“ Ø³ØªØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙÙŠ: dist/', 'cyan');
    log('ğŸ’» Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Windows 10/11', 'cyan');
    log('ğŸ“¦ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø³ØªÙ‚Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…\n', 'cyan');

  } catch (error) {
    log('\nâŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡', 'red');
    log(`   ${error.message}\n`, 'red');
    process.exit(1);
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
if (require.main === module) {
  main().catch(error => {
    log(`\nâŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error.message}\n`, 'red');
    process.exit(1);
  });
}

module.exports = {
  checkRequiredFiles,
  cleanOldBuilds,
  installDependencies,
  buildApplication,
  verifyBuild
};
