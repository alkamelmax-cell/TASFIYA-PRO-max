<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØµÙÙŠØ© Ø¨Ø±Ùˆ - Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (v18)</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/custom.css?v=21">

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

</head>

<body>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay"
        style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 9999; align-items: center; justify-content: center;">
        <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; border-width: 4px;"
                role="status"></div>
            <div class="mt-3 text-white fw-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="custom-navbar navbar-layout mb-4">
        <!-- Brand Section -->
        <div class="navbar-brand-section">
            <div class="brand-logo">
                <img src="assets/logo.png" alt="TP"
                    style="height: 45px; width: auto; margin-left: 10px; border-radius: 8px;">ØªØµÙÙŠØ© Ø¨Ø±Ùˆ
            </div>
        </div>

        <!-- Links Section -->
        <div class="navbar-links-section">
            <a href="index.html" class="btn btn-sm btn-primary fw-bold text-white px-3 py-2 rounded-pill shadow-sm">
                <i class="fas fa-home me-1"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
            <a href="request-reconciliation.html"
                class="btn btn-sm btn-outline-success fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-plus-circle me-1"></i> Ø·Ù„Ø¨ ØªØµÙÙŠØ©
            </a>
            <a href="reconciliation-requests.html"
                class="btn btn-sm btn-outline-warning fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-inbox me-1"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
            </a>
            <a href="atm-reports.html"
                class="btn btn-sm btn-outline-secondary fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-credit-card me-1"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ±Ø§Ù
            </a>
            <a href="customer-ledger.html"
                class="btn btn-sm btn-outline-secondary fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-book me-1"></i> Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </a>
            <a href="users-management.html" id="navUsersMgmt"
                class="btn btn-sm btn-outline-secondary fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-users-cog me-1"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            </a>
            <a href="cashiers-management.html"
                class="btn btn-sm btn-outline-secondary fw-bold text-white px-3 py-2 rounded-pill border-0 hover-bg-primary">
                <i class="fas fa-cash-register me-1"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±
            </a>
        </div>

        <!-- User Section -->
        <div class="dropdown navbar-user-section">
            <button class="user-profile-btn" type="button" data-bs-toggle="dropdown">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px;">
                    <i class="fas fa-user text-white"></i>
                </div>
                <span id="userNameDisplay" class="d-none d-md-inline fw-bold font-monospace small">Admin</span>
                <i class="fas fa-chevron-down small opacity-50"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end bg-card border-secondary shadow-lg mt-2">
                <!-- Manual Push Registration Button -->
                <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" onclick="retryPushRegistration()">
                        <i class="fas fa-bell text-warning"></i> <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (E)</span>
                    </a></li>
                <li>
                    <hr class="dropdown-divider bg-secondary opacity-25">
                </li>
                <li><a class="dropdown-item text-danger d-flex align-items-center gap-2" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </a></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid px-3 px-md-4">

        <!-- Stats Row -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-lg-3">
                <div class="stat-box">
                    <i class="fas fa-clipboard-check icon-wrapper"></i>
                    <div class="stat-label">Ø§Ù„ØªØµÙÙŠØ§Øª</div>
                    <div class="stat-value" id="statsTotalCount">0</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="stat-box">
                    <i class="fas fa-coins icon-wrapper text-success"></i>
                    <div class="stat-label">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</div>
                    <div class="stat-value text-success" id="statsTotalReceipts">0</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="stat-box">
                    <i class="fas fa-chart-line icon-wrapper text-info"></i>
                    <div class="stat-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                    <div class="stat-value text-info" id="statsTotalSales">0</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="stat-box">
                    <!-- Cash Total -->
                    <i class="fas fa-money-bill-wave icon-wrapper text-success"></i>
                    <div class="stat-label">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</div>
                    <div class="stat-value text-success" id="statsTotalCash">0</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-container mb-4">
            <div class="section-title">
                <i class="fas fa-search small text-primary"></i>
                Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
            </div>
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <label class="custom-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="custom-input w-100" id="filterDateFrom">
                </div>
                <div class="col-6 col-md-3">
                    <label class="custom-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="custom-input w-100" id="filterDateTo">
                </div>
                <div class="col-6 col-md-2">
                    <label class="custom-label">Ø§Ù„ÙØ±Ø¹</label>
                    <select class="custom-input form-select w-100" id="filterBranch">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="custom-label">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</label>
                    <select class="custom-input form-select w-100" id="filterCashier">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="custom-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select class="custom-input form-select w-100" id="filterStatus">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
                        <option value="draft">Ù…Ø¹Ù„Ù‚Ø©</option>
                    </select>
                </div>
                <!-- Buttons Row -->
                <div class="col-12 mt-3">
                    <div class="d-flex gap-2">
                        <button id="refreshBtn" type="button" class="btn btn-secondary px-3" onclick="handleRefresh()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-primary flex-grow-1 fw-bold" onclick="loadReconciliations()">
                            Ø¨Ø­Ø«
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="pro-card mb-4 min-vh-100">
            <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                <div class="section-title mb-0">Ø³Ø¬Ù„ Ø§Ù„ØªØµÙÙŠØ§Øª</div>
                <small class="text-secondary" id="recordCount">0 Ø³Ø¬Ù„</small>
            </div>

            <div class="table-container border-0">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„ØªØµÙÙŠØ©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>
                            <th class="d-none d-md-table-cell">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</th>
                            <th class="text-ltr d-none d-md-table-cell">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                            <th class="text-ltr d-none d-md-table-cell">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                            <th class="text-ltr">Ø§Ù„Ø¹Ø¬Ø²/Ø§Ù„ÙØ§Ø¦Ø¶</th>
                            <th class="text-center-header d-none d-md-table-cell">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="text-center">Ø§Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="reconciliationsTableBody">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold text-white">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙÙŠØ©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="modalBody">
                    <!-- Dynamic -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auth Check
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/login.html';
        }
        const user = JSON.parse(userStr || '{}');
        document.getElementById('userNameDisplay').textContent = user.name || 'Admin';


        // Redirect Cashier Immediately
        if (user.role === 'cashier') {
            window.location.href = 'request-reconciliation.html';
        }

        // Initialize OneSignal Logic
        if (user.role === 'admin' || !user.role) {

            // IS APP? (Median.co / GoNative)
            if (navigator.userAgent.indexOf('gonative') > -1) {
                console.log("ğŸ“± Running in App Mode - Using Native Bridge");

                const tagsData = {
                    "role": "admin",
                    "userId": user.id ? String(user.id) : "unknown"
                };

                // Method A: Direct JS Bridge
                if (window.gonative && window.gonative.onesignal) {
                    window.gonative.onesignal.tags.setTags(tagsData);
                }

                // Method B: URL Protocol (Robust Fail-safe)
                try {
                    const jsonTags = JSON.stringify(tagsData);
                    setTimeout(() => {
                        window.location.href = `gonative://onesignal/tags/setTags?tags=${encodeURIComponent(jsonTags)}`;
                    }, 1500); // 1.5s delay
                } catch (e) { console.error("Median URL Error", e); }

                // â›” STOP HERE for App: Do NOT run web init to avoid conflict
            }
            else {
                // IS BROWSER? -> Run Standard Web Push Init
                console.log("ğŸ’» Running in Browser Mode");

                window.OneSignalDeferred = window.OneSignalDeferred || [];
                OneSignalDeferred.push(async function (OneSignal) {
                    try {
                        await OneSignal.init({
                            appId: "1b7778f5-0f25-4df8-a281-611b682a964c",
                            allowLocalhostAsSecureOrigin: true,
                        });

                        // Tag user
                        await OneSignal.User.addTag("role", "admin");
                        const userId = user.id ? String(user.id) : "unknown";
                        await OneSignal.User.addTag("userId", userId);

                        if (OneSignal.Notifications.permission === "default") {
                            await OneSignal.Notifications.requestPermission();
                        }
                    } catch (error) {
                        console.error("OneSignal Error:", error);
                    }
                });
            }
        }


        // Check Permissions
        const protectedPages = [
            'atm-reports.html',
            'customer-ledger.html',
            'users-management.html',
            'cashiers-management.html'
        ];

        if (user.permissions && Array.isArray(user.permissions)) {
            // New Logic: Check specific permissions
            protectedPages.forEach(page => {
                if (!user.permissions.includes(page)) {
                    const el = document.querySelector(`a[href="${page}"]`);
                    if (el) el.classList.add('d-none');
                }
            });
        } else if (user.role && user.role !== 'admin') {
            // Legacy Fallback: Hide all protected for non-admins
            protectedPages.forEach(page => {
                const el = document.querySelector(`a[href="${page}"]`);
                if (el) el.classList.add('d-none');
            });
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        const API_URL = '/api';

        document.addEventListener('DOMContentLoaded', async () => {
            // Defaults: This Month (Disabled to show all)
            // const date = new Date();
            // const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
            // const today = new Date().toISOString().split('T')[0];

            // document.getElementById('filterDateFrom').value = firstDay;
            // document.getElementById('filterDateTo').value = today;

            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';

            await loadLookups();
            loadReconciliations();
        });

        async function loadLookups() {
            try {
                const res = await fetch(`${API_URL}/lookups`);
                const data = await res.json();
                if (data.success) {
                    const branchSelect = document.getElementById('filterBranch');
                    // Check if branches exist in response
                    if (data.branches) {
                        data.branches.forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b.id;
                            opt.textContent = b.name;
                            branchSelect.appendChild(opt);
                        });
                    }

                    const cashierSelect = document.getElementById('filterCashier');
                    data.cashiers.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        cashierSelect.appendChild(opt);
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadReconciliations() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const branchId = document.getElementById('filterBranch').value;
            const cashierId = document.getElementById('filterCashier').value;
            const status = document.getElementById('filterStatus').value;

            const params = new URLSearchParams();
            let hasFilters = false;

            if (dateFrom) {
                params.append('dateFrom', dateFrom);
                hasFilters = true;
            }
            if (dateTo) {
                params.append('dateTo', dateTo);
                hasFilters = true;
            }
            if (branchId && branchId !== 'all') {
                params.append('branchId', branchId);
                hasFilters = true;
            }
            if (cashierId && cashierId !== 'all') {
                params.append('cashierId', cashierId);
                hasFilters = true;
            }
            if (status && status !== 'all') {
                params.append('status', status);
                hasFilters = true;
            }

            // Create params for stats (exact copy of filters BUT WITHOUT limit)
            const statsParams = new URLSearchParams(params);

            // If no filters are active, limit main list to last 100 records
            if (!hasFilters) {
                params.append('limit', '100');
            }

            showLoading(true);
            try {
                // Fetch Data and Stats in parallel
                const [listRes, statsRes] = await Promise.all([
                    fetch(`${API_URL}/reconciliations?${params.toString()}`),
                    fetch(`${API_URL}/reconciliations/stats?${statsParams.toString()}`)
                ]);

                const listResult = await listRes.json();
                const statsResult = await statsRes.json();

                if (listResult.success) {
                    renderTable(listResult.data);

                    // Show info message if showing limited results
                    if (!hasFilters) {
                        const countEl = document.getElementById('recordCount');
                        countEl.innerHTML = `${listResult.data.length} Ø³Ø¬Ù„ <small class="text-muted">(Ø¢Ø®Ø± 100 ØªØµÙÙŠØ©)</small>`;
                    }
                }

                if (statsResult.success && statsResult.stats) {
                    calculateStatsFromAPI(statsResult.stats);
                } else if (listResult.success) {
                    // Fallback to client-side calculation if stats API fails
                    calculateStats(listResult.data);
                }

            } catch (error) {
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        function calculateStatsFromAPI(stats) {
            document.getElementById('statsTotalCount').textContent = formatNum(stats.count);
            document.getElementById('statsTotalReceipts').textContent = formatCurrency(stats.totalReceipts);
            document.getElementById('statsTotalSales').textContent = formatCurrency(stats.totalSales);
            document.getElementById('statsTotalCash').textContent = formatCurrency(stats.totalCash);
        }

        function renderTable(data) {
            const tbody = document.getElementById('reconciliationsTableBody');
            tbody.innerHTML = '';
            document.getElementById('recordCount').textContent = `${data.length} Ø³Ø¬Ù„`;

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-5"><div class="text-muted opacity-50"><i class="fas fa-inbox fa-3x mb-3"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div></td></tr>`;
                return;
            }

            data.forEach(row => {
                const surplus = Number(row.surplus_deficit || 0);
                const surplusClass = surplus >= 0 ? 'text-success' : 'text-danger';
                const statusBadge = row.status === 'completed'
                    ? '<div class="status-badge status-completed"><i class="fas fa-check-circle"></i> Ù…ÙƒØªÙ…Ù„Ø©</div>'
                    : '<div class="status-badge status-pending"><i class="fas fa-clock"></i> Ù…Ø¹Ù„Ù‚Ø©</div>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="#" class="text-white fw-bold font-monospace">${row.reconciliation_number || '<span class="badge bg-secondary opacity-50">Ù…Ø³ÙˆØ¯Ø©</span>'}</td>
                    <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="font-monospace">${new Date(row.reconciliation_date).toLocaleDateString('en-GB')}</td>
                    <td data-label="Ø§Ù„ÙƒØ§Ø´ÙŠØ±" class="text-white">${row.cashier_name || '-'}</td>
                    <td data-label="Ø§Ù„Ù…Ø­Ø§Ø³Ø¨" class="text-white d-none d-md-table-cell">${row.accountant_name || '-'}</td>
                    <td data-label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª" class="font-monospace text-success fw-bold text-ltr d-none d-md-table-cell">${formatCurrency(row.total_receipts)}</td>
                    <td data-label="Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" class="font-monospace text-white text-ltr d-none d-md-table-cell">${formatCurrency(row.system_sales)}</td>
                    <td data-label="Ø§Ù„Ø¹Ø¬Ø² / Ø§Ù„ÙØ§Ø¦Ø¶" class="${surplusClass} fw-bold font-monospace text-ltr" dir="ltr">${formatCurrency(surplus)}</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="text-center-cell d-none d-md-table-cell">${statusBadge}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" class="text-center-cell">
                        <button class="btn btn-primary btn-sm btn-action-mobile" onclick="openDetails(${row.id})">
                            Ø¹Ø±Ø¶
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateStats(data) {
            const count = data.length;
            const totalReceipts = data.reduce((sum, r) => sum + Number(r.total_receipts || 0), 0);
            const totalSales = data.reduce((sum, r) => sum + Number(r.system_sales || 0), 0);
            const totalCash = data.reduce((sum, r) => sum + Number(r.cash_total || 0), 0);

            document.getElementById('statsTotalCount').textContent = formatNum(count);
            document.getElementById('statsTotalReceipts').textContent = formatCurrency(totalReceipts);
            document.getElementById('statsTotalSales').textContent = formatCurrency(totalSales);
            document.getElementById('statsTotalCash').textContent = formatCurrency(totalCash);
        }

        async function openDetails(id) {
            showLoading(true);
            try {
                const res = await fetch(`${API_URL}/reconciliation/${id}`);
                const result = await res.json();
                if (result.success) renderModalContent(result.data);
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            } catch (error) { console.error(error); }
            finally { showLoading(false); }
        }

        function renderModalContent(data) {
            const rec = data.reconciliation;
            const cash = data.cashReceipts || [];
            const bank = data.bankReceipts || [];

            const totalCashAmount = cash.reduce((sum, c) => sum + Number(c.total_amount), 0);

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                    <div>
                        <small class="text-secondary d-block">Ø±Ù‚Ù… Ø§Ù„ØªØµÙÙŠØ©</small>
                        <span class="text-white fw-bold">#${rec.reconciliation_number || rec.id}</span>
                    </div>
                    <div>
                        <div class="status-badge ${rec.status === 'completed' ? 'status-completed' : 'status-pending'}">
                            ${rec.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„Ø©' : 'Ù…Ø³ÙˆØ¯Ø©'}
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-secondary d-block">Ø§Ù„ØªØ§Ø±ÙŠØ®</small>
                        <span class="fw-bold text-white font-monospace">${new Date(rec.reconciliation_date).toLocaleDateString('en-GB')}</span>
                    </div>
                </div>

                <!-- Summary Grid -->
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</label>
                        <div class="value text-primary font-monospace" dir="ltr">${formatCurrency(rec.system_sales).replace(' SAR', '')}</div>
                    </div>
                    <div class="summary-item">
                        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</label>
                        <div class="value text-success font-monospace" dir="ltr">${formatCurrency(rec.total_receipts).replace(' SAR', '')}</div>
                    </div>
                    <div class="summary-item">
                        <label>Ø§Ù„ÙØ±Ù‚</label>
                        <div class="value ${rec.surplus_deficit >= 0 ? 'text-success' : 'text-danger'} font-monospace" dir="ltr">
                            ${formatCurrency(rec.surplus_deficit).replace(' SAR', '')}
                        </div>
                    </div>
                </div>

                <!-- Cash Details Table -->
                <h6 class="section-title text-sm mb-3 text-white"><i class="fas fa-money-bill-wave text-success me-2"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h6>
                <div class="modal-table">
                    <table class="w-100">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th class="text-center">Ø§Ù„Ø¹Ø¯Ø¯</th>
                                <th class="text-ltr">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cash.map(c => `
                                <tr>
                                    <td>${c.denomination}</td>
                                    <td class="text-center font-monospace">${c.quantity}</td>
                                    <td class="font-monospace text-ltr">${formatCurrency(c.total_amount).replace(' SAR', '')}</td>
                                </tr>
                            `).join('')}
                            <tr class="bg-opacity-10" style="background-color: rgba(16, 185, 129, 0.05) !important;">
                                <td colspan="2" class="fw-bold text-success">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´</td>
                                <td class="text-success fw-bold font-monospace text-ltr">${formatCurrency(totalCashAmount).replace(' SAR', '')}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Bank Details -->
                <h6 class="section-title text-sm mb-3 mt-4 text-white"><i class="fas fa-credit-card text-warning me-2"></i> Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ©</h6>
                <div class="d-flex flex-column gap-2">
                    ${bank.map(b => `
                        <div class="d-flex justify-content-between align-items-center p-3 rounded" style="background-color: #0f172a; border: 1px solid #334155;">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-warning bg-opacity-10 p-2 rounded text-warning"><i class="fas fa-credit-card"></i></div>
                                <div>
                                    <div class="fw-bold text-white small">${b.operation_type || 'Ø¨Ø·Ø§Ù‚Ø©'}</div>
                                    <small class="text-secondary opacity-75" style="font-size: 0.75rem">${b.atm_name || '-'}</small>
                                </div>
                            </div>
                            <div class="font-monospace fw-bold text-white text-ltr">${formatCurrency(b.amount).replace(' SAR', '')}</div>
                        </div>
                    `).join('')}
                    ${bank.length === 0 ? '<div class="text-center py-3 text-muted small border border-dashed border-secondary rounded">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø¨ÙƒØ©</div>' : ''}
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
        }

        async function resetAllData() {
            const confirmed = confirm(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙÙŠØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!\n\n' +
                'Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Ø§Ù„ØµÙØ±.\n\n' +
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
            );

            if (!confirmed) return;

            try {
                showLoading(true);
                const res = await fetch(`${API_URL}/reconciliations/reset`, {
                    method: 'POST'
                });
                const result = await res.json();

                if (result.success) {
                    alert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙƒØªØ¨ÙŠ.');
                    loadReconciliations(); // Reload to show empty table
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            } finally {
                showLoading(false);
            }
        }

        function formatCurrency(val) {
            return Number(val || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatNum(val) {
            // Compact format for cards (e.g. 1.2k) if needed, currently full number
            return Number(val || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        // Manual Push Retry Check
        function retryPushRegistration() {
            alert('Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ø¨Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...');

            const tagsData = {
                "role": "admin",
                "userId": user.id ? String(user.id) : "unknown",
                "force_update": Date.now()
            };
            const jsonTags = JSON.stringify(tagsData);

            // 1. Try URL Protocol (Register FIRST, then Tags)
            try {
                // Force Registration
                window.location.href = 'gonative://onesignal/register';
                console.log("Sent Register Command");

                // Send Tags after short delay to allow registration
                setTimeout(() => {
                    window.location.href = `gonative://onesignal/tags/setTags?tags=${encodeURIComponent(jsonTags)}`;
                    console.log("Sent Median Tags via URL (Manual)");
                }, 2000);
            } catch (e) { console.error(e); }

            // 2. Check if environment is detected (gonative OR median)
            const isApp = navigator.userAgent.toLowerCase().includes('gonative') || navigator.userAgent.toLowerCase().includes('median');

            if (isApp) {
                setTimeout(() => alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.\nØªØ­Ù‚Ù‚ Ù…Ù† OneSignal Ø§Ù„Ø¢Ù†.'), 1000);
            } else {
                alert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (UserAgent) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙˆÙ„ÙƒÙ† ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ "Ø¨Ø§Ù„Ù‚ÙˆØ©" Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„.\n\nØ¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙÙŠ OneSignalØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø­!');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        async function handleRefresh() {
            const btn = document.getElementById('refreshBtn');
            const icon = btn.querySelector('i');

            // Add spinning animation
            icon.classList.add('fa-spin');
            btn.disabled = true;

            try {
                await loadReconciliations();

                // Optional: Show toast or feedback
                // alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); 
            } catch (e) {
                console.error(e);
            } finally {
                // Remove animation after short delay
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    btn.disabled = false;
                }, 500);
            }
        }

        // Smart Navigation Logic
        document.addEventListener('DOMContentLoaded', () => {
            const homeLink = document.querySelector('a[href="index.html"]');
            if (homeLink) {
                homeLink.addEventListener('click', (e) => {
                    // If we are already on index.html (or root), prevent reload and just refresh data
                    const currentPath = window.location.pathname;
                    if (currentPath.endsWith('index.html') || currentPath === '/') {
                        e.preventDefault();
                        handleRefresh();
                    }
                });
            }
        });
    </script>
</body>

</html>