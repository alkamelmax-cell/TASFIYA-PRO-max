<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طلبات التصفية المعلقة</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="css/custom.css?v=8" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-dark text-light">

    <!-- Navbar -->
    <nav class="custom-navbar d-flex justify-content-between align-items-center mb-4">
        <div class="brand-logo">
            <i class="fas fa-inbox text-warning"></i>
            <span>طلبات <span class="text-primary">التصفية</span></span>
        </div>
        <div>
            <a href="index.html" class="btn btn-outline-light btn-sm rounded-pill">
                <i class="fas fa-arrow-right me-1"></i> عودة للرئيسية
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="card glass-card border-0">
            <div
                class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-white"><i class="fas fa-clock text-warning me-2"></i> طلبات التصفية المعلقة</h5>
                <button class="btn btn-sm btn-outline-info" onclick="loadRequests()">
                    <i class="fas fa-sync-alt"></i> تحديث
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="text-secondary">#</th>
                                <th class="text-secondary">التاريخ</th>
                                <th class="text-secondary">الكاشير</th>
                                <th class="text-secondary text-center">إجمالي النقد</th>
                                <th class="text-secondary text-center">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check Auth
        const userStr = localStorage.getItem('user');
        if (!userStr) window.location.href = '/login.html';
        const user = JSON.parse(userStr);

        async function loadRequests() {
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">جاري التحميل...</td></tr>';

            try {
                const res = await fetch('/api/reconciliation-requests');
                const data = await res.json();

                if (data.success) {
                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-white-50"><i class="fas fa-check-circle fa-3x mb-3 opacity-50"></i><br>لا توجد طلبات معلقة</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.data.map(req => {
                        const details = req.details || {};
                        const cashTotal = (details.cashItems || []).reduce((sum, item) => sum + (Number(item.sub) || 0), 0);

                        // Fix Date Issue: Append 'Z' to treat as UTC, then let browser convert to local
                        let dateStr = req.created_at;
                        // Assuming the DB returns "YYYY-MM-DD HH:MM:SS" without Z
                        if (dateStr && !dateStr.endsWith('Z')) {
                            dateStr = dateStr.replace(' ', 'T') + 'Z';
                        }
                        const date = new Date(dateStr);

                        const formattedDate = date.toLocaleDateString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        const formattedTime = date.toLocaleTimeString('en-GB', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });

                        const formattedDateTime = `${formattedDate} ${formattedTime}`;

                        return `
                            <tr>
                                <td class="font-monospace fw-bold text-white">#${req.id}</td>
                                <td class="font-monospace text-white small" dir="ltr">${formattedDateTime}</td>
                                <td class="fw-bold text-white">${req.cashier_name || 'غير معروف'}</td>
                                <td class="text-center font-monospace text-success fw-bold dir-ltr">${cashTotal.toFixed(2)}</td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-danger" onclick="deleteRequest(${req.id})">
                                            <i class="fas fa-trash-alt"></i> حذف
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">خطأ: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">فشل الاتصال بالخادم</td></tr>`;
            }
        }

        async function deleteRequest(id) {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم حذف هذا الطلب نهائياً ولا يمكن التراجع عنه!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                background: '#1e293b',
                color: '#fff'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/reconciliation-requests/${id}`, { method: 'DELETE' });
                    const data = await res.json();

                    if (data.success) {
                        await Swal.fire({
                            title: 'تم الحذف!',
                            text: 'تم حذف الطلب بنجاح.',
                            icon: 'success',
                            background: '#1e293b',
                            color: '#fff',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        loadRequests();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'خطأ!',
                        text: error.message,
                        icon: 'error',
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            }
        }

        // Load on start
        loadRequests();
    </script>
</body>

</html>