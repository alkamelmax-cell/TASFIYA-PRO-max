<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="css/custom.css?v=21" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

</head>

<body class="bg-dark text-light">

    <!-- Navbar -->
    <nav class="custom-navbar navbar-layout d-flex justify-content-between align-items-center mb-4">
        <div class="navbar-brand-section">
            <div class="brand-logo">
                <img src="assets/logo.png" alt="TP"
                    style="height: 40px; width: auto; margin-left: 10px; border-radius: 8px;">ØªØµÙÙŠØ© Ø¨Ø±Ùˆ
            </div>
        </div>
        <div>
            <a href="index.html" class="btn btn-outline-light btn-sm rounded-pill">
                <i class="fas fa-arrow-right me-1"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="card glass-card border-0">
            <div
                class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-white"><i class="fas fa-clock text-warning me-2"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h5>
                <button class="btn btn-sm btn-outline-info" onclick="loadRequests()">
                    <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
            <div class="card-body p-0">
                <!-- Desktop Table View -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-dark table-hover mb-0 align-middle custom-table reconciliation-table">
                        <thead>
                            <tr>
                                <th class="text-secondary">#</th>
                                <th class="text-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="text-secondary">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>
                                <th class="text-secondary text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø¯</th>
                                <th class="text-secondary text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards View -->
                <div id="mobileCardsContainer" class="d-md-none p-3">
                    <div class="text-center py-4 text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check Auth
        const userStr = localStorage.getItem('user');
        if (!userStr) window.location.href = '/login.html';
        const user = JSON.parse(userStr);

        // Permission Check
        const isAllowed = (user.role === 'admin') || (user.permissions && user.permissions.includes('reconciliation-requests.html'));
        if (!isAllowed) {
            window.location.href = 'index.html';
        }

        // Initialize OneSignal Logic (Official)
        // 1. Official Callback
        window.median_onesignal_info = function (data) {
            console.log("ğŸ“± Median App Detected via Official Callback", data);

            const tagsData = {
                "role": "admin",
                "userId": user.id ? String(user.id) : "unknown"
            };

            // Strategy A
            if (window.gonative && window.gonative.onesignal) {
                window.gonative.onesignal.tags.setTags(tagsData);
            }

            // Strategy B (Backup)
            setTimeout(() => {
                const jsonTags = JSON.stringify(tagsData);
                window.location.href = `gonative://onesignal/tags/setTags?tags=${encodeURIComponent(jsonTags)}`;
            }, 1000);
        };

        // 2. Initialize Logic
        if (user.role === 'admin' || !user.role) {
            const ua = navigator.userAgent.toLowerCase();
            const isMedianApp = ua.indexOf('gonative') > -1 || ua.indexOf('median') > -1;

            if (isMedianApp) {
                console.log("ğŸ“± Running in App Mode - Force setting tags...");

                const tagsData = {
                    "role": "admin",
                    "userId": user.id ? String(user.id) : "unknown",
                    "force": Date.now()
                };

                setTimeout(() => {
                    // Try to send Tags AND External ID via URL Scheme
                    const jsonTags = JSON.stringify(tagsData);
                    window.location.href = `gonative://onesignal/tags/setTags?tags=${encodeURIComponent(jsonTags)}`;

                    if (user.id) {
                        setTimeout(() => {
                            window.location.href = `gonative://onesignal/user/setExternalId?externalId=${user.id}`;
                        }, 500);
                    }
                }, 2000);
            }
            else {
                // BROWSER MODE
                window.OneSignalDeferred = window.OneSignalDeferred || [];
                OneSignalDeferred.push(async function (OneSignal) {
                    try {
                        await OneSignal.init({
                            appId: "1b7778f5-0f25-4df8-a281-611b682a964c",
                            allowLocalhostAsSecureOrigin: true,
                        });
                        await OneSignal.User.addTag("role", "admin");
                        const userId = user.id ? String(user.id) : "unknown";

                        if (OneSignal.Notifications.permission === "default") {
                            await OneSignal.Notifications.requestPermission();
                        }
                    } catch (error) { console.error("OneSignal Web Error:", error); }
                });
            }
        }

        async function loadRequests(silent = false) {
            const tbody = document.getElementById('requestsTableBody');
            const cardsContainer = document.getElementById('mobileCardsContainer');

            if (!silent) {
                const loadingHtml = '<tr><td colspan="5" class="text-center py-4 text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
                tbody.innerHTML = loadingHtml;
                cardsContainer.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            }

            try {
                const res = await fetch('/api/reconciliation-requests');
                const data = await res.json();

                if (data.success) {
                    if (data.data.length === 0) {
                        const emptyHtml = '<tr><td colspan="5" class="text-center py-5 text-white-50"><i class="fas fa-check-circle fa-3x mb-3 opacity-50"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
                        tbody.innerHTML = emptyHtml;
                        cardsContainer.innerHTML = '<div class="text-center py-5 text-white-50"><i class="fas fa-check-circle fa-3x mb-3 opacity-50"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>';
                        return;
                    }

                    // Render Desktop Table
                    tbody.innerHTML = data.data.map(req => {
                        const details = req.details || {};
                        let cashTotal = Number(req.total_cash);
                        if (isNaN(cashTotal) || cashTotal === 0) {
                            cashTotal = (details.cashItems || []).reduce((sum, item) => sum + (Number(item.sub) || 0), 0);
                        }

                        // Date Formatting
                        let dateStr = req.created_at;
                        if (dateStr && !dateStr.endsWith('Z')) dateStr = dateStr.replace(' ', 'T') + 'Z';
                        const date = new Date(dateStr);
                        const formattedDate = date.toLocaleDateString('en-GB');
                        const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });

                        return `
                            <tr>
                                <td class="font-monospace fw-bold text-white">#${req.id}</td>
                                <td class="text-white">
                                    <div class="d-flex flex-column align-items-start">
                                        <span class="font-monospace fw-bold">${formattedDate}</span>
                                        <span class="font-monospace text-info small">${formattedTime}</span>
                                    </div>
                                </td>
                                <td class="fw-bold text-white">${req.cashier_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                                <td class="text-center font-monospace text-success fw-bold dir-ltr fs-5">${cashTotal.toFixed(2)}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-danger px-3 rounded-pill" onclick="deleteRequest(${req.id})">
                                        <i class="fas fa-trash-alt me-1"></i> Ø­Ø°Ù
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // Render Mobile Cards
                    cardsContainer.innerHTML = data.data.map(req => {
                        const details = req.details || {};
                        let cashTotal = Number(req.total_cash);
                        if (isNaN(cashTotal) || cashTotal === 0) {
                            cashTotal = (details.cashItems || []).reduce((sum, item) => sum + (Number(item.sub) || 0), 0);
                        }

                        let dateStr = req.created_at;
                        if (dateStr && !dateStr.endsWith('Z')) dateStr = dateStr.replace(' ', 'T') + 'Z';
                        const date = new Date(dateStr);
                        const formattedDate = date.toLocaleDateString('en-GB');
                        const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true }); // AM/PM mostly preferred on mobile

                        return `
                        <div class="card glass-card mb-3 border border-secondary border-opacity-25 shadow-lg overflow-hidden position-relative">
                            <!-- Card Decoration Line -->
                            <div class="position-absolute top-0 end-0 bottom-0 bg-success" style="width: 4px;"></div>
                            
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="fw-bold text-white mb-1">
                                            <i class="fas fa-user-circle text-secondary me-1"></i> ${req.cashier_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                                        </h5>
                                        <div class="text-white-50 small font-monospace">
                                            <i class="far fa-clock me-1"></i> ${formattedDate} | ${formattedTime}
                                        </div>
                                    </div>
                                    <span class="badge bg-dark border border-secondary text-light font-monospace">#${req.id}</span>
                                </div>
                                
                                <hr class="border-secondary opacity-25 my-2">
                                
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="d-flex flex-column">
                                        <span class="text-secondary small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø¯</span>
                                        <span class="fs-3 fw-bold text-success font-monospace dir-ltr">${cashTotal.toFixed(2)} <small class="fs-6 text-white-50">SAR</small></span>
                                    </div>
                                    
                                    <button class="btn btn-outline-danger btn-sm rounded-3 px-3 py-2" onclick="deleteRequest(${req.id})">
                                        <i class="fas fa-trash-alt"></i> Ø­Ø°Ù
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');

                } else {
                    const errorHtml = `<tr><td colspan="5" class="text-center text-danger">Ø®Ø·Ø£: ${data.error}</td></tr>`;
                    tbody.innerHTML = errorHtml;
                    cardsContainer.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${data.error}</div>`;
                }
            } catch (error) {
                console.error(error);
                const failHtml = `<tr><td colspan="5" class="text-center text-danger">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</td></tr>`;
                tbody.innerHTML = failHtml;
                cardsContainer.innerHTML = `<div class="alert alert-danger">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>`;
            }
        }

        async function deleteRequest(id) {
            const result = await Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                background: '#1e293b',
                color: '#fff'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/reconciliation-requests/${id}`, { method: 'DELETE' });
                    const data = await res.json();

                    if (data.success) {
                        await Swal.fire({
                            title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                            text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.',
                            icon: 'success',
                            background: '#1e293b',
                            color: '#fff',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        loadRequests();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'Ø®Ø·Ø£!',
                        text: error.message,
                        icon: 'error',
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            }
        }

        // Load on start
        loadRequests();

        // Auto-refresh every 5 seconds to show real-time updates
        setInterval(() => {
            // Only refresh if no modal/alert is open to avoid disrupting user
            if (!document.querySelector('.swal2-container')) {
                loadRequests(true); // Pass true to indicate silent refresh
            }
        }, 5000);
    </script>
</body>

</html>